# WIP: Ansible Debian 12 Router (Dualstack ipv4/ipV6, Nftables, Dnsmasq, Adguard, Netdata Monitoring, Wireguard on snapshotted BTRFS + NAS) This is my customization / Fork which adapts the following:

- WARNING: CURRENTLY, THIS IS WORK IN PROGRESS

- It is a heavy modification of : [this blog post](https://tongkl.com/building-a-router-from-scratch-part-1/)
  

- TODO: adjusted to use Intel i225 + X710 dual fiber NICs on an Asrock N100DC-ITX
- TODO: Switch to nftables, do not use / block iptables.. 
- TODO: add tasks for setting up BTRFS / snapper snapshots.. also for grub
- TODO: Swap Pihole for Adguard home (baremetall installation)
- TODO: Use dnsmasq DHCP Server instead of isc (ISC is no longer maintained!)... use wide-dhcp client for upstream ipv6
- TODO: modify ansible task to spawn Serial console on N100 ITX 
- TODO: add tasks to install zsh / oh my zsh + tools for standard user
- TODO: add installation for NEtdata
- TODO: remove all bridge interfaces.. rely on firewall / routing only between different interfaces / vlans (for increased security and slightly more centralized setup)
- TODO: Setup Wireguard mesh to webserver / clients
- TODO: ? install caddy http reverse proxy ?
- TODO: Install / Setup Samba / NFS / SFTP


Curretnly hardcoded (you might want to search/replace them in the configs) if adapting to your system)
hardcoded constants:

## networkinterfaces:


### enp0s0f0np0
 - not used, WAN interface without VLAN

###  enp0s0f0np0.10
- actual WAN interface with VLAN ID as required by ISP
### enp0s0f1np1
 - primary LAN interface
### enp2s0
 - auxiliiary interface without DHCP
### enp3s0
 - secondary LAN itnerface, wired to access point
  
### enp3s0.100
 - Guest WIFI VLAN (Wifi / SSID are configured on AP, not on the router)
  
### enp3s0.100
 - Ghetto WiFI VLAN (Wifi/ SSID are configured on AP, not on the router)


# Credits / Sources

- A lot of parts / detail solutions have been generated by ChatGPT, the core strucuture for individual aspects was taken from:

## Ansible Layout
- heavily modified / rewritten but intitially based on https://tongkl.com/building-a-router-from-scratch-part-1/
  - compared to the guide, config for Network, Firewall, Adblocker and DHCP / IPv6 prefix delegation has been replaced with alternate approaches

## Systemd-Networkd
- base template for Systemd IPv6 Prefix Delegation: https://blog.g3rt.nl/systemd-networkd-dhcpv6-pd-configuration.html

## nftables
- Heavy inspiration from the genrated nftabl√∂es ruleset of my previous OpenWRT router
- He

## Chrony / NTP server
- https://chrony-project.org/examples.html
- https://github.com/jauderho/nts-servers




# Building A Router from Scratch with Debian 12

An Ansible playbook that builds a router from scratch on Debian 12 in one command.

This repo is the implementation of .

## How to Run

Clone this repo and open in an IDE. Use global find and replace to substitute the following fields:

* `TIMEZONE_TO_BE_FILLED`: e.g. `America/Chicago`
* `enp1s0f0np0`: the WAN port you want your router to use. e.g. `enp1s0`
* `LAN_PORTS_LIST`: the LAN ports you want you router to use. e.g. `enp2s0 enp3s0 enp4s0`
* `ULA_PREFIX_TO_BE_FILLED`: the ULA prefix you want to use in your LAN. e.g. `fd00::`. Do not put `/64` as it is in the config files already.
* Go to `roles/router/tasks/conf/interfaces`. Replace these commented lines with your LAN ports:
``` bash
  # TODO: replace the following with your LAN ports
  # up ip link set enp2s0 up
  # up ip link set enp3s0 up
  # up ip link set enp4s0 up
```
* Go to `inventory/group_vars/all/vars.yaml` and replace the user name with your preferred user name the router will use.
* By default the Pi-hole admin portal is on port `8765`. Search and replace to whatever port you like.

The Ansible configuration is now done.

Perform a fresh install of Debian 12 on your future router. Give the user sudo privilege. Configure the router to have the static IP `192.168.10.1` on one of the LAN interfaces so that you can connect to it via `ssh`. Plug the WAN cable in the WAN port and configure it to use DHCP so the machine has Internet access. Install `python3` and `openssh-server` on the machine.

``` bash
$ sudo apt install openssh-server python3
```

Copy the ssh keys of your Ansible host to the router. You are good to go. Just run Ansible and it will be done.

``` bash
$ ansible-playbook -i inventory/hosts playbooks/router/main.yaml -K
```
